<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Algolix Health AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            color: #e2e8f0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        /* Modern header section with branding */
        .header-section {
            text-align: center;
            margin-bottom: 60px;
            max-width: 800px;
        }

        .brand-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 28px;
            font-weight: 800;
            color: white;
            box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
        }

        .brand-name {
            font-size: 2.5rem;
            font-weight: 800;
            color: #ffffff;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .brand-tagline {
            font-size: 1.5rem;
            font-weight: 600;
            color: #94a3b8;
            margin-bottom: 16px;
            letter-spacing: -0.01em;
        }

        .brand-description {
            font-size: 1.1rem;
            color: #64748b;
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Modern chat container */
        .chat-container {
            width: 100%;
            max-width: 800px;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .chat-messages {
            height: 400px;
            overflow-y: auto;
            padding: 32px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            scrollbar-width: thin;
            scrollbar-color: rgba(148, 163, 184, 0.3) transparent;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background-color: rgba(148, 163, 184, 0.3);
            border-radius: 10px;
        }

        .message {
            display: flex;
            gap: 16px;
            animation: slideInUp 0.4s ease-out forwards;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .message-content {
            flex: 1;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
            padding: 20px;
            color: #e2e8f0;
            line-height: 1.7;
            max-width: 85%;
        }

        .message.user .message-content {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.2);
        }

        /* Modern input area */
        .input-area {
            padding: 32px;
            border-top: 1px solid rgba(148, 163, 184, 0.1);
            background: rgba(15, 23, 42, 0.9);
        }

        .input-container {
            display: flex;
            align-items: center;
            gap: 16px;
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid rgba(148, 163, 184, 0.1);
            border-radius: 20px;
            padding: 16px 24px;
            transition: all 0.3s ease;
        }

        .input-container:focus-within {
            border-color: rgba(16, 185, 129, 0.5);
            background: rgba(30, 41, 59, 0.9);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
        }

        .message-input {
            flex: 1;
            background: none;
            border: none;
            color: #e2e8f0;
            font-size: 1rem;
            outline: none;
            resize: none;
            min-height: 24px;
            max-height: 120px;
            line-height: 1.5;
        }

        .message-input::placeholder {
            color: #64748b;
        }

        .input-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .input-btn {
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            background: rgba(148, 163, 184, 0.1);
            color: #94a3b8;
        }

        .input-btn:hover {
            background: rgba(148, 163, 184, 0.2);
            color: #e2e8f0;
            transform: scale(1.05);
        }

        .voice-btn.recording {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            animation: pulse 1s infinite;
        }

        .voice-mode-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .voice-mode-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .send-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background: rgba(148, 163, 184, 0.1);
        }

        /* Status indicators */
        .recording-indicator {
            display: none;
            align-items: center;
            gap: 12px;
            color: #ef4444;
            font-size: 0.9rem;
            margin-bottom: 16px;
            padding: 12px 20px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 12px;
        }

        .recording-dot {
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 12px;
            color: #64748b;
            font-style: italic;
            margin-bottom: 16px;
            padding: 12px 20px;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 12px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #64748b;
            border-radius: 50%;
            animation: typingDot 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        /* Voice Modal Styles */
        .voice-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .voice-modal-content {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 24px;
            padding: 48px;
            text-align: center;
            max-width: 480px;
            width: 90%;
            backdrop-filter: blur(20px);
        }

        .voice-modal-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: #ffffff;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .voice-modal-subtitle {
            color: #94a3b8;
            margin-bottom: 40px;
            font-size: 1.1rem;
        }

        .voice-selection {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-bottom: 40px;
        }

        .voice-option {
            padding: 16px 24px;
            border: 2px solid rgba(148, 163, 184, 0.2);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #94a3b8;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(30, 41, 59, 0.4);
        }

        .voice-option.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .voice-option:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .voice-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 40px auto;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
        }

        .voice-circle:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.4);
        }

        .voice-circle.listening {
            animation: pulse 2s infinite;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .voice-circle.speaking {
            animation: pulse 1.5s infinite;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .letter-a {
            font-size: 3rem;
            font-weight: 800;
            color: white;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .voice-status {
            color: #e2e8f0;
            font-size: 1.1rem;
            margin-bottom: 32px;
            min-height: 30px;
        }

        .voice-controls {
            display: flex;
            gap: 16px;
            justify-content: center;
        }

        .voice-control-btn {
            background: rgba(148, 163, 184, 0.1);
            border: none;
            border-radius: 12px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #94a3b8;
            font-size: 1.2rem;
        }

        .voice-control-btn:hover {
            background: rgba(148, 163, 184, 0.2);
            transform: scale(1.05);
        }

        .voice-close-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .speaking-indicator {
            display: none;
            position: fixed;
            top: 24px;
            right: 24px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            padding: 12px 20px;
            color: #4facfe;
            font-size: 0.9rem;
            backdrop-filter: blur(20px);
            z-index: 1001;
            align-items: center;
            gap: 8px;
        }

        .speaking-dot {
            width: 8px;
            height: 8px;
            background: #4facfe;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        .snow-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .snowflake {
            position: absolute;
            top: -10px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 1rem;
            animation: snowfall linear infinite;
            pointer-events: none;
        }

        /* Animations */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
        }

        @keyframes typingDot {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes snowfall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .app-container {
                padding: 16px;
            }

            .header-section {
                margin-bottom: 40px;
            }

            .brand-name {
                font-size: 2rem;
            }

            .brand-tagline {
                font-size: 1.2rem;
            }

            .brand-description {
                font-size: 1rem;
            }

            .chat-messages {
                height: 300px;
                padding: 24px;
            }

            .input-area {
                padding: 24px;
            }

            .voice-modal-content {
                padding: 32px;
            }
        }

        /* Chat history sidebar */
        .chat-history {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 300px;
            max-height: 80vh;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
            padding: 20px;
            z-index: 1000;
            transform: translateX(-320px);
            transition: transform 0.3s ease;
            overflow-y: auto;
        }

        .chat-history.open {
            transform: translateX(0);
        }

        .chat-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .chat-history-title {
            color: #e2e8f0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .close-history {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .close-history:hover {
            color: #e2e8f0;
            background: rgba(148, 163, 184, 0.1);
        }

        .chat-item {
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-item:hover {
            background: rgba(30, 41, 59, 0.8);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .chat-item-content {
            flex: 1;
            min-width: 0;
        }

        .chat-item-delete {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
            margin-left: 8px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .chat-item:hover .chat-item-delete {
            opacity: 1;
        }

        .chat-item-delete:hover {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .chat-item-title {
            color: #e2e8f0;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chat-item-preview {
            color: #64748b;
            font-size: 0.8rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chat-item-date {
            color: #475569;
            font-size: 0.7rem;
            margin-top: 4px;
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 15px;
        }

        .new-chat-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .history-toggle {
            position: fixed;
            top: 30px;
            left: 30px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 12px;
            padding: 12px;
            color: #e2e8f0;
            cursor: pointer;
            z-index: 1001;
            transition: all 0.2s ease;
        }

        .history-toggle:hover {
            background: rgba(30, 41, 59, 0.9);
            border-color: rgba(16, 185, 129, 0.3);
        }
    </style>
</head>
<body>
    <div class="app-container">
         <!-- Chat History Toggle -->
        <button class="history-toggle" onclick="toggleChatHistory()">
            <i class="fas fa-history"></i>
        </button>

         <!-- Chat History Sidebar -->
        <div class="chat-history" id="chatHistory">
            <div class="chat-history-header">
                <h3 class="chat-history-title">Chat History</h3>
                <button class="close-history" onclick="toggleChatHistory()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <button class="new-chat-btn" onclick="startNewChat()">
                <i class="fas fa-plus"></i> New Chat
            </button>
            <div id="chatHistoryList">
                 <!-- Chat history items will be populated here -->
            </div>
        </div>

         <!-- Modern header section -->
        <div class="header-section">
            
            <h1 class="brand-name">Algolix</h1>
            <p class="brand-tagline">AI Health Assistant</p>
            <p class="brand-description">
                Your intelligent health companion powered by advanced AI. Get personalized health insights, medical information, and wellness guidance through natural conversation and voice interaction.
            </p>
        </div>

         <!-- Modern chat container -->
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <div class="message assistant">
                    <div class="message-avatar">AI</div>
                    <div class="message-content">
                        <p>Hello! I'm Algolix, your AI health assistant. I can help you with:</p>
                        <ul style="margin-top: 12px; margin-left: 20px; list-style-type: disc;">
                            <li>Health information and medical guidance</li>
                            <li>Wellness tips and lifestyle recommendations</li>
                            <li>Symptom analysis and health monitoring</li>
                            <li>Natural voice health consultations</li>
                        </ul>
                        <p style="margin-top: 16px;">
                            <strong>💡 Pro tip:</strong> Use voice mode for hands-free health conversations!
                        </p>
                        <p style="margin-top: 12px; font-size: 0.9rem; color: #64748b;">
                            <em>Note: I provide general health information. Always consult healthcare professionals for medical advice.</em>
                        </p>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <div class="recording-indicator" id="recordingIndicator">
                    <div class="recording-dot"></div>
                    <span>Recording... Click microphone to stop</span>
                </div>
                
                <div class="typing-indicator" id="typingIndicator">
                    <span>AI is thinking</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>

                <div class="input-container">
                    <textarea 
                        class="message-input" 
                        id="messageInput" 
                        placeholder="Ask anything..."
                        rows="1"
                    ></textarea>
                    
                    <div class="input-actions">
                        <button class="input-btn voice-btn" id="voiceBtn" onclick="toggleVoiceRecording()" title="Voice Recording">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button class="input-btn voice-mode-btn" id="voiceModeBtn" onclick="openVoiceModal()" title="Voice Mode">
                            <i class="fas fa-comments"></i>
                        </button>
                        <button class="input-btn send-btn" id="sendBtn" onclick="sendMessage()" title="Send Message">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

     <!-- Voice Mode Modal -->
    <div class="voice-modal" id="voiceModal">
        <div class="snow-container" id="snowContainer"></div>
        
        <div class="voice-modal-content">
            <h2 class="voice-modal-title">Algolix Voice Mode</h2>
            <p class="voice-modal-subtitle">Choose your preferred voice and speak naturally about your health</p>
            
            <div class="voice-selection">
                <div class="voice-option selected" onclick="selectVoice('female')" data-voice="female">
                    <i class="fas fa-female"></i> Female Voice
                </div>
                <div class="voice-option" onclick="selectVoice('male')" data-voice="male">
                    <i class="fas fa-male"></i> Male Voice
                </div>
            </div>
            
            <div class="voice-circle" id="voiceCircle" onclick="startVoiceMode()">
                <div class="letter-a">AI</div>
            </div>

            <div class="voice-status" id="voiceStatus">Click AI to start speaking</div>
            
            <div class="voice-controls">
                <button class="voice-control-btn voice-close-btn" onclick="closeVoiceModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="speaking-indicator" id="speakingIndicator">
        <div class="speaking-dot"></div>
        <span>AI is speaking...</span>
    </div>

    <script>
        let currentChatId = null;
        let chatHistory = JSON.parse(localStorage.getItem('algolix_chat_history') || '[]');

        function generateChatId() {
            return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function saveChatToHistory() {
            const messages = Array.from(document.querySelectorAll('.message')).map(msg => {
                const isUser = msg.classList.contains('user');
                const content = msg.querySelector('.message-content').textContent;
                return { sender: isUser ? 'user' : 'assistant', content };
            });

            if (messages.length <= 1) return; // Don't save if only welcome message

            const chatTitle = messages.find(m => m.sender === 'user')?.content.substring(0, 50) + '...' || 'New Chat';
            
            const existingChatIndex = chatHistory.findIndex(chat => chat.id === currentChatId);
            const chatData = {
                id: currentChatId,
                title: chatTitle,
                messages: messages,
                timestamp: new Date().toISOString(),
                preview: messages[messages.length - 1]?.content.substring(0, 100) + '...' || ''
            };

            if (existingChatIndex >= 0) {
                chatHistory[existingChatIndex] = chatData;
            } else {
                chatHistory.unshift(chatData);
            }

            // Keep only last 50 chats
            if (chatHistory.length > 50) {
                chatHistory = chatHistory.slice(0, 50);
            }

            localStorage.setItem('algolix_chat_history', JSON.stringify(chatHistory));
            updateChatHistoryUI();
        }

        function loadChatFromHistory(chatId) {
            const chat = chatHistory.find(c => c.id === chatId);
            if (!chat) return;

            currentChatId = chatId;
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';

            chat.messages.forEach(msg => {
                addMessage(msg.sender, msg.content, false); // false = don't save to history
            });

            toggleChatHistory(); // Close sidebar
        }

        function startNewChat() {
            currentChatId = generateChatId();
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            // Add welcome message
            addMessage('assistant', `Hello! I'm Algolix, your AI health assistant. I can help you with:

• Health information and medical guidance
• Wellness tips and lifestyle recommendations  
• Symptom analysis and health monitoring
• Natural voice health consultations

💡 Pro tip: Use voice mode for hands-free health conversations!

Note: I provide general health information. Always consult healthcare professionals for medical advice.`, false);
            
            toggleChatHistory(); // Close sidebar
        }

        function deleteChatFromHistory(chatId, event) {
            event.stopPropagation(); // Prevent chat from loading when delete is clicked
            
            if (confirm('Are you sure you want to delete this chat?')) {
                chatHistory = chatHistory.filter(chat => chat.id !== chatId);
                localStorage.setItem('algolix_chat_history', JSON.stringify(chatHistory));
                updateChatHistoryUI();
                
                // If current chat is deleted, start new chat
                if (currentChatId === chatId) {
                    startNewChat();
                }
            }
        }

        function updateChatHistoryUI() {
            const historyList = document.getElementById('chatHistoryList');
            historyList.innerHTML = '';

            chatHistory.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.onclick = () => loadChatFromHistory(chat.id);
                
                const date = new Date(chat.timestamp).toLocaleDateString();
                chatItem.innerHTML = `
                    <div class="chat-item-content">
                        <div class="chat-item-title">${chat.title}</div>
                        <div class="chat-item-preview">${chat.preview}</div>
                        <div class="chat-item-date">${date}</div>
                    </div>
                    <button class="chat-item-delete" onclick="deleteChatFromHistory('${chat.id}', event)" title="Delete chat">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                
                historyList.appendChild(chatItem);
            });
        }

        function toggleChatHistory() {
            const chatHistory = document.getElementById('chatHistory');
            chatHistory.classList.toggle('open');
        }

        function addMessage(sender, content, saveToHistory = true) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = sender === 'user' ? 'U' : 'AI';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.innerHTML = formatMessage(content);
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            if (saveToHistory) {
                setTimeout(() => saveChatToHistory(), 500); // Small delay to ensure message is rendered
            }
        }

        function formatMessage(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            currentChatId = generateChatId();
            updateChatHistoryUI();
            
            initSpeechRecognition();
            initializeVoices();
            
            // Auto-resize textarea
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // Send message on Enter (but not Shift+Enter)
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });

        let isRecording = false;
        let recognition = null;
        let currentFetchController = null;

        let selectedVoiceGender = 'female';
        let preferredVoice = null;
        let voicesLoaded = false;
        let voiceMode = false;
        let voiceModeRecognition = null;
        let isVoiceModeRecording = false;
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;
        let isSpeaking = false;

        function createSnowfall() {
            const snowContainer = document.getElementById('snowContainer');
            const snowflakeCount = 50;
            
            for (let i = 0; i < snowflakeCount; i++) {
                const snowflake = document.createElement('div');
                snowflake.className = 'snowflake';
                snowflake.innerHTML = '❄';
                snowflake.style.left = Math.random() * 100 + '%';
                snowflake.style.animationDuration = Math.random() * 3 + 2 + 's';
                snowflake.style.animationDelay = Math.random() * 2 + 's';
                snowContainer.appendChild(snowflake);
            }
        }

        function selectVoice(gender) {
            selectedVoiceGender = gender;
            document.querySelectorAll('.voice-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`[data-voice="${gender}"]`).classList.add('selected');
            
            if (!voicesLoaded) {
                console.log('[v0] Voices not loaded yet, waiting...');
                return;
            }
            
            updatePreferredVoice(gender);
        }

        function updatePreferredVoice(gender) {
            const voices = speechSynthesis.getVoices();
            console.log('[v0] Available voices:', voices.length);
            
            if (gender === 'female') {
                preferredVoice = voices.find(voice => 
                    voice.name.toLowerCase().includes('female') ||
                    voice.name.toLowerCase().includes('zira') ||
                    voice.name.toLowerCase().includes('susan') ||
                    voice.name.toLowerCase().includes('samantha') ||
                    voice.name.toLowerCase().includes('karen') ||
                    (voice.lang.startsWith('en') && voice.name.includes('Google') && voice.name.includes('Female'))
                ) || voices.find(voice => voice.lang.startsWith('en') && !voice.name.toLowerCase().includes('male'));
            } else {
                preferredVoice = voices.find(voice => 
                    voice.name.toLowerCase().includes('male') ||
                    voice.name.toLowerCase().includes('david') ||
                    voice.name.toLowerCase().includes('mark') ||
                    voice.name.toLowerCase().includes('alex') ||
                    (voice.lang.startsWith('en') && voice.name.includes('Google') && voice.name.includes('Male'))
                ) || voices.find(voice => voice.lang.startsWith('en'));
            }
            
            console.log('[v0] Selected voice:', preferredVoice ? preferredVoice.name : 'Default');
        }

        function speakText(text) {
            if (isSpeaking) {
                speechSynthesis.cancel();
            }

            if (!text || text.trim() === '') return;

            const cleanText = text.replace(/[*_`#]/g, '').replace(/\n+/g, ' ').trim();
            
            currentUtterance = new SpeechSynthesisUtterance(cleanText);
            
            if (preferredVoice) {
                currentUtterance.voice = preferredVoice;
            } else {
                const voices = speechSynthesis.getVoices();
                const fallbackVoice = voices.find(voice => voice.lang.startsWith('en')) || voices[0];
                if (fallbackVoice) {
                    currentUtterance.voice = fallbackVoice;
                }
            }
            
            currentUtterance.rate = 0.9;
            currentUtterance.pitch = 1.0;
            currentUtterance.volume = 0.8;
            
            currentUtterance.onstart = function() {
                isSpeaking = true;
                console.log('[v0] AI started speaking');
                const speakingIndicator = document.getElementById('speakingIndicator');
                if (speakingIndicator) {
                    speakingIndicator.style.display = 'flex';
                }
            };
            
            currentUtterance.onend = function() {
                isSpeaking = false;
                console.log('[v0] AI finished speaking');
                const speakingIndicator = document.getElementById('speakingIndicator');
                if (speakingIndicator) {
                    speakingIndicator.style.display = 'none';
                }
            };
            
            currentUtterance.onerror = function(event) {
                console.error('[v0] Speech synthesis error:', event.error);
                isSpeaking = false;
                const speakingIndicator = document.getElementById('speakingIndicator');
                if (speakingIndicator) {
                    speakingIndicator.style.display = 'none';
                }
            };
            
            speechSynthesis.speak(currentUtterance);
        }

        function stopSpeaking() {
            if (isSpeaking) {
                speechSynthesis.cancel();
                isSpeaking = false;
                const speakingIndicator = document.getElementById('speakingIndicator');
                if (speakingIndicator) {
                    speakingIndicator.style.display = 'none';
                }
            }
        }

        function openVoiceModal() {
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                alert('Voice mode requires HTTPS or localhost. Please use a secure connection.');
                return;
            }

            document.getElementById('voiceModal').style.display = 'flex';
            createSnowfall();
            initVoiceModeRecognition();
            
            if (!voicesLoaded) {
                initializeVoices();
            }
        }

        function closeVoiceModal() {
            document.getElementById('voiceModal').style.display = 'none';
            if (voiceModeRecognition && isVoiceModeRecording) {
                voiceModeRecognition.stop();
            }
            stopSpeaking();
        }

        function startVoiceMode() {
            const voiceCircle = document.getElementById('voiceCircle');
            const voiceStatus = document.getElementById('voiceStatus');

            if (!voiceModeRecognition) {
                alert('Speech recognition is not available. Please use Chrome, Edge, or Safari with microphone permissions.');
                return;
            }

            if (!isVoiceModeRecording) {
                console.log('[v0] Starting voice mode');
                try {
                    voiceModeRecognition.start();
                } catch (error) {
                    console.error('[v0] Error starting voice mode recognition:', error);
                    document.getElementById('voiceStatus').textContent = 'Could not start voice recognition. Please check your microphone permissions.';
                }
            }
        }

        function initVoiceModeRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.warn('[v0] Speech recognition not supported for voice mode');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            voiceModeRecognition = new SpeechRecognition();
            voiceModeRecognition.continuous = false;
            voiceModeRecognition.interimResults = true;
            voiceModeRecognition.lang = 'en-US';

            voiceModeRecognition.onstart = function() {
                console.log('[v0] Voice mode recognition started');
                isVoiceModeRecording = true;
                const circle = document.getElementById('voiceCircle');
                const status = document.getElementById('voiceStatus');
                
                circle.classList.add('listening');
                circle.classList.remove('speaking');
                status.textContent = 'Listening...';
            };

            voiceModeRecognition.onresult = function(event) {
                let finalTranscript = '';
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                const status = document.getElementById('voiceStatus');
                if (finalTranscript) {
                    console.log('[v0] Voice mode final transcript:', finalTranscript);
                    status.textContent = 'Processing...';
                    sendVoiceModeMessage(finalTranscript);
                } else if (interimTranscript) {
                    status.textContent = `"${interimTranscript}"`;
                }
            };

            voiceModeRecognition.onerror = function(event) {
                console.error('[v0] Voice mode recognition error:', event.error);
                stopVoiceModeRecording();
                
                const status = document.getElementById('voiceStatus');
                let errorMessage = 'Error: ';
                switch(event.error) {
                    case 'not-allowed':
                        errorMessage = 'Microphone access denied. Please allow microphone access.';
                        break;
                    case 'no-speech':
                        errorMessage = 'No speech detected. Click AI to try again.';
                        break;
                    case 'audio-capture':
                        errorMessage = 'No microphone found. Please check your microphone.';
                        break;
                    case 'network':
                        errorMessage = 'Network error. Please check your connection.';
                        break;
                    default:
                        errorMessage += event.error;
                }
                status.textContent = errorMessage;
            };

            voiceModeRecognition.onend = function() {
                console.log('[v0] Voice mode recognition ended');
                stopVoiceModeRecording();
            };
        }

        function stopVoiceModeRecording() {
            isVoiceModeRecording = false;
            const circle = document.getElementById('voiceCircle');
            circle.classList.remove('listening');
        }

        async function sendVoiceModeMessage(message) {
            if (!message.trim()) return;

            const circle = document.getElementById('voiceCircle');
            const status = document.getElementById('voiceStatus');
            
            try {
                status.textContent = 'Thinking...';
                
                if (currentFetchController) {
                    currentFetchController.abort();
                }
                currentFetchController = new AbortController();

                console.log('[v0] Sending voice mode message:', message);

                const formData = new FormData();
                formData.append('msg', message);

                const response = await fetch('/get', {
                    method: 'POST',
                    body: formData,
                    signal: currentFetchController.signal
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const aiResponse = await response.text();
                console.log('[v0] Voice mode AI response:', aiResponse.substring(0, 100) + '...');

                status.textContent = 'Speaking...';
                circle.classList.add('speaking');
                circle.classList.remove('listening');
                
                speakVoiceModeText(aiResponse);

            } catch (error) {
                console.error('[v0] Voice mode API error:', error);
                if (error.name !== 'AbortError') {
                    status.textContent = 'Sorry, I encountered an error. Please try again.';
                    speakVoiceModeText('Sorry, I encountered an error. Please try again.');
                }
            }
        }

        function speakVoiceModeText(text) {
            if (isSpeaking) {
                speechSynthesis.cancel();
            }

            if (!text || text.trim() === '') return;

            const cleanText = text.replace(/[*_`#]/g, '').replace(/\n+/g, ' ').trim();
            
            currentUtterance = new SpeechSynthesisUtterance(cleanText);
            
            if (preferredVoice) {
                currentUtterance.voice = preferredVoice;
            } else {
                const voices = speechSynthesis.getVoices();
                const fallbackVoice = voices.find(voice => voice.lang.startsWith('en')) || voices[0];
                if (fallbackVoice) {
                    currentUtterance.voice = fallbackVoice;
                }
            }
            
            currentUtterance.rate = 0.9;
            currentUtterance.pitch = 1.0;
            currentUtterance.volume = 0.8;
            
            currentUtterance.onstart = function() {
                isSpeaking = true;
                console.log('[v0] Voice mode AI started speaking');
            };
            
            currentUtterance.onend = function() {
                isSpeaking = false;
                console.log('[v0] Voice mode AI finished speaking');
                const circle = document.getElementById('voiceCircle');
                const status = document.getElementById('voiceStatus');
                
                circle.classList.remove('speaking');
                status.textContent = 'Click AI to start speaking';
            };
            
            currentUtterance.onerror = function(event) {
                console.error('[v0] Voice mode speech synthesis error:', event.error);
                isSpeaking = false;
                const circle = document.getElementById('voiceCircle');
                const status = document.getElementById('voiceStatus');
                
                circle.classList.remove('speaking');
                status.textContent = 'Speech error. Click AI to try again.';
            };
            
            speechSynthesis.speak(currentUtterance);
        }

        function initializeVoices() {
            function loadVoices() {
                const voices = speechSynthesis.getVoices();
                if (voices.length > 0) {
                    voicesLoaded = true;
                    console.log('[v0] Voices loaded:', voices.length);
                    updatePreferredVoice(selectedVoiceGender);
                    return true;
                }
                return false;
            }

            if (!loadVoices()) {
                speechSynthesis.onvoiceschanged = function() {
                    if (loadVoices()) {
                        speechSynthesis.onvoiceschanged = null;
                    }
                };
            }
        }

        // Initialize speech recognition
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';

                recognition.onstart = function() {
                    console.log('Speech recognition started');
                    isRecording = true;
                    document.getElementById('voiceBtn').classList.add('recording');
                    document.getElementById('recordingIndicator').style.display = 'flex';
                };

                recognition.onresult = function(event) {
                    let finalTranscript = '';
                    let interimTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    const messageInput = document.getElementById('messageInput');
                    if (finalTranscript) {
                        messageInput.value = finalTranscript;
                        console.log('Final transcript:', finalTranscript);
                    } else if (interimTranscript) {
                        messageInput.value = interimTranscript;
                        console.log('Interim transcript:', interimTranscript);
                    }
                };

                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    stopRecording();
                    if (event.error === 'not-allowed') {
                        alert('Microphone access denied. Please allow microphone access and try again.');
                    }
                };

                recognition.onend = function() {
                    console.log('Speech recognition ended');
                    stopRecording();
                };
            } else {
                console.warn('Speech recognition not supported in this browser');
                document.getElementById('voiceBtn').style.display = 'none';
            }
        }

        function stopRecording() {
            isRecording = false;
            document.getElementById('voiceBtn').classList.remove('recording');
            document.getElementById('recordingIndicator').style.display = 'none';
        }

        function toggleVoiceRecording() {
            if (!recognition) {
                alert('Speech recognition is not supported in your browser. Please use Chrome, Edge, or Safari.');
                return;
            }

            if (!isRecording) {
                console.log('Starting speech recognition');
                recognition.start();
            } else {
                console.log('Stopping speech recognition');
                recognition.stop();
            }
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) return;

            // Add user message to chat
            addMessage('user', message);
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // Show typing indicator
            document.getElementById('typingIndicator').style.display = 'flex';

            try {
                if (currentFetchController) {
                    currentFetchController.abort();
                }
                currentFetchController = new AbortController();

                const formData = new FormData();
                formData.append('msg', message);

                const response = await fetch('/get', {
                    method: 'POST',
                    body: formData,
                    signal: currentFetchController.signal
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const aiResponse = await response.text();
                
                // Hide typing indicator
                document.getElementById('typingIndicator').style.display = 'none';
                
                // Add AI response to chat
                addMessage('assistant', aiResponse);

            } catch (error) {
                console.error('API error:', error);
                document.getElementById('typingIndicator').style.display = 'none';
                
                if (error.name !== 'AbortError') {
                    addMessage('assistant', 'Sorry, I encountered an error. Please try again.');
                }
            }
        }

        
    </script>
</body>
</html>
